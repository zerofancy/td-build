name: Build TDLib for macOS (Apple Silicon)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14  # 使用更稳定的macOS版本，15可能存在兼容性问题
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read specific commit hash from file
        id: get-commit
        run: |
          COMMIT_HASH=$(cat tdlib-commit.txt | tr -d '\n')  # 确保没有换行符
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "Read commit hash: $COMMIT_HASH"
        
      - name: Install Xcode command line tools
        run: |
          xcode-select --install || true  # 忽略已安装的错误
          # 等待安装完成
          while ! xcode-select -p &> /dev/null; do
            sleep 10
          done
      
      - name: Install Homebrew dependencies
        run: |
          brew install gperf openssl coreutils openjdk
          # 安装最新版本的CMake（解决版本兼容问题）
          brew install cmake
          # 确保使用brew安装的cmake而非系统自带
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          cmake --version  # 验证cmake版本
      
      - name: Set Java environment variables
        run: |
          echo "JAVA_HOME=$(/usr/libexec/java_home)" >> $GITHUB_ENV
          echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
      
      - name: Clone TDLib repository
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git submodule update --init --recursive
      
      - name: Checkout specific commit
        run: |
          cd td
          git checkout $COMMIT_HASH
          echo "Checked out commit: $COMMIT_HASH"
          
      - name: Build and install TDLib core
        run: |
          cd td
          rm -rf build
          mkdir -p build
          cd build
          # 修复CMake版本兼容性问题
          cmake -DCMAKE_POLICY_DEFAULT_CMP0091=NEW \
                -DCMAKE_MINIMUM_REQUIRED_VERSION=3.5 \
                -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
                -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td \
                -DTD_ENABLE_JNI=ON ..
          cmake --build . --target install --config Release -j$(sysctl -n hw.ncpu)
      
      - name: Build and install Java example
        run: |
          cd td/example/java
          rm -rf build
          mkdir -p build
          cd build
          cmake -DCMAKE_POLICY_DEFAULT_CMP0091=NEW \
                -DCMAKE_MINIMUM_REQUIRED_VERSION=3.5 \
                -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX:PATH=../../../tdlib \
                -DTd_DIR:PATH=$(greadlink -e ../td/lib/cmake/Td) ..
          cmake --build . --target install --config Release -j$(sysctl -n hw.ncpu)
      
      - name: List build output (debug)
        run: |
          cd td
          ls -l tdlib
          ls -l tdlib/bin || true
          ls -l tdlib/lib || true
      
      - name: Package JAR with main class
        run: |
          cd td/tdlib/bin
          jar cvfe tdlib.jar org.drinkless.tdlib.example.Example .
          mv tdlib.jar ../
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-macos-build
          path: |
            td/tdlib/
            td/tdlib/tdlib.jar
          retention-days: 30
