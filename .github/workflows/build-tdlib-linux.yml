name: Build TDLib on Ubuntu 22.04

on:
  push:
    branches: [ main ]
  # pull_request:
    # branches: [ main ]
  workflow_dispatch:

jobs:
  build-tdlib:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Read specific commit hash from file
      id: get-commit
      run: |
        # 假设commit哈希存储在仓库根目录的tdlib-commit.txt文件中
        COMMIT_HASH=$(cat tdlib-commit.txt)
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
        echo "Read commit hash: $COMMIT_HASH"
        
    - name: Update and upgrade system packages
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        
    - name: Install required dependencies
      run: |
        sudo apt-get install -y make git zlib1g-dev libssl-dev gperf php-cli cmake default-jdk g++
        
    - name: Clone TDLib repository
      run: |
        git clone https://github.com/tdlib/td.git
        
    - name: Checkout specific commit
      run: |
        cd td
        git checkout $COMMIT_HASH
        echo "Checked out commit: $COMMIT_HASH"
        
    - name: Build and install TDLib
      run: |
        cd td
        rm -rf build
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td -DTD_ENABLE_JNI=ON ..
        cmake --build . --target install
        cd ..
        cd example/java
        rm -rf build
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX:PATH=../../../tdlib -DTd_DIR:PATH=$(readlink -e ../td/lib/cmake/Td) ..
        cmake --build . --target install
        cd ../../..
        cd ..

    - name: List build output
      run: |
        cd td
        ls -l tdlib
        ls -l tdlib/bin
        ls -l tdlib/docs
    - name: Package JAR with main class
      run: |
        cd td/tdlib/bin
        jar cvfe tdlib.jar org.drinkless.tdlib.example.Example .
        mv tdlib.jar ../
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tdlib-linux-build
        path: |
          td/tdlib/
          td/tdlib/tdlib.jar
        retention-days: 30
